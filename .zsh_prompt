function prompt_git_branch {
    ref=$(git symbolic-ref HEAD 2>/dev/null) || return
    index=$(git status --porcelain 2>/dev/null) || return
    echo -n " on "
    [ $index ] && echo -n "%{$fg[magenta]%}"
    echo -n "${ref#refs/heads/}"
    [ $index ] && echo "%{$reset_color%}"
}

function prompt_return_code {
     echo "%(?.. %{$fg[red]%}[%?]%{$reset_color%})"
}

function prompt_char {
    [ $UID = 0 ] && echo '#' && return
    echo '$'
}

function precmd {
    PROMPT="%{$fg[magenta]%}%n%{$reset_color%} at%{$fg[yellow]%} %m%{$reset_color%} in %{$fg_bold[green]%}%~%{$reset_color%}$(prompt_git_branch)%t$(prompt_return_code)
$(prompt_char) "
}
